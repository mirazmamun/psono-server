before_script:
  - docker info
  - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com

variables:
  CONTAINER_TEST_IMAGE2: registry.gitlab.com/psono/psono-server:python2-$CI_BUILD_REF_NAME
  CONTAINER_TEST_IMAGE3: registry.gitlab.com/psono/psono-server:python3-$CI_BUILD_REF_NAME
  CONTAINER_RELEASE_IMAGE2: registry.gitlab.com/psono/psono-server:python2-latest
  CONTAINER_RELEASE_IMAGE3: registry.gitlab.com/psono/psono-server:python3-latest
  CONTAINER_LATEST_IMAGE: registry.gitlab.com/psono/psono-server:latest

stages:
  - build
  - test
  - release
  - deploy

build-container-python2:
  except:
    - schedules
  stage: build
  image: docker:git
  services:
    - docker:dind
  script:
    - sh ./var/update_version.sh
    - docker build -f Dockerfile2ubuntu1604 -t $CONTAINER_TEST_IMAGE2 .
    - docker push $CONTAINER_TEST_IMAGE2

build-container-python3:
  except:
    - schedules
  stage: build
  image: docker:git
  services:
    - docker:dind
  script:
    - sh ./var/update_version.sh
    - docker build -f Dockerfile3ubuntu1604 -t $CONTAINER_TEST_IMAGE3 .
    - docker push $CONTAINER_TEST_IMAGE3

run-unittests-python2:
  except:
    - schedules
  stage: test
  image: docker:git
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: ""
    PSONO_EMAIL_HOST: 172.17.0.1
    PSONO_EMAIL_FROM: test@example.com
    PSONO_ACTIVATION_LINK_SECRET: 9SruC2qPmKScVzGaF4378LW4rvNNkK2G3Gddqy9kPQqgkjeDQjs7jaLBCstgtJTt
    PSONO_SECRET_KEY: RQTKawYQv4w6KkuphcLzLu7r5ap7xE5DSDu5SkKXjMnWBQ93mcMKjdZfeZkY2Y7C
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE2
    - docker run -d --name db postgres:9.6
    - sleep 20
    - docker run --link db:postgres $CONTAINER_TEST_IMAGE2 bash -c "pip2 install -r requirements-dev.txt && python2 ./psono/manage.py presetup && python2 ./psono/manage.py migrate && coverage2 run --source='.' ./psono/manage.py test restapi.tests && coverage2 report --omit=psono/restapi/migrations/*,psono/middleware/*,psono/restapi/tests*"


run-unittests-python3:
  except:
    - schedules
  stage: test
  image: docker:git
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: ""
    PSONO_EMAIL_HOST: 172.17.0.1
    PSONO_EMAIL_FROM: test@example.com
    PSONO_ACTIVATION_LINK_SECRET: 9SruC2qPmKScVzGaF4378LW4rvNNkK2G3Gddqy9kPQqgkjeDQjs7jaLBCstgtJTt
    PSONO_SECRET_KEY: RQTKawYQv4w6KkuphcLzLu7r5ap7xE5DSDu5SkKXjMnWBQ93mcMKjdZfeZkY2Y7C
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE3
    - docker run -d --name db postgres:9.6
    - sleep 20
    - docker run --link db:postgres $CONTAINER_TEST_IMAGE3 bash -c "pip3 install -r requirements-dev.txt && python3 ./psono/manage.py presetup && python3 ./psono/manage.py migrate && coverage3 run --source='.' ./psono/manage.py test restapi.tests && coverage3 report --omit=psono/restapi/migrations/*,psono/middleware/*,psono/restapi/tests*"


run-unittests-python3-centos7:
  except:
    - schedules
  stage: test
  image: docker:git
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: ""
    PSONO_EMAIL_HOST: 172.17.0.1
    PSONO_EMAIL_FROM: test@example.com
    PSONO_ACTIVATION_LINK_SECRET: 9SruC2qPmKScVzGaF4378LW4rvNNkK2G3Gddqy9kPQqgkjeDQjs7jaLBCstgtJTt
    PSONO_SECRET_KEY: RQTKawYQv4w6KkuphcLzLu7r5ap7xE5DSDu5SkKXjMnWBQ93mcMKjdZfeZkY2Y7C
  services:
    - docker:dind
  script:
    - sh ./var/update_version.sh
    - docker build -f Dockerfile3centos7 -t centos-testimage .
    - docker run -d --name db postgres:9.6
    - sleep 20
    - docker run --link db:postgres centos-testimage bash -c "pip3 install -r requirements-dev.txt && python3 ./psono/manage.py presetup && python3 ./psono/manage.py migrate && coverage3 run --source='.' ./psono/manage.py test restapi.tests && coverage3 report --omit=psono/restapi/migrations/*,psono/middleware/*,psono/restapi/tests*"


run-unittests-python3-rhel7:
  except:
    - schedules
  stage: test
  image: docker:git
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: ""
    PSONO_EMAIL_HOST: 172.17.0.1
    PSONO_EMAIL_FROM: test@example.com
    PSONO_ACTIVATION_LINK_SECRET: 9SruC2qPmKScVzGaF4378LW4rvNNkK2G3Gddqy9kPQqgkjeDQjs7jaLBCstgtJTt
    PSONO_SECRET_KEY: RQTKawYQv4w6KkuphcLzLu7r5ap7xE5DSDu5SkKXjMnWBQ93mcMKjdZfeZkY2Y7C
  services:
    - docker:dind
  script:
    - sh ./var/update_version.sh
    - docker build -f Dockerfile3rhel7 -t rhel-testimage .
    - docker run -d --name db postgres:9.6
    - sleep 20
    - docker run --link db:postgres rhel-testimage bash -c "pip3 install -r requirements-dev.txt && python3 ./psono/manage.py presetup && python3 ./psono/manage.py migrate && coverage3 run --source='.' ./psono/manage.py test restapi.tests && coverage3 report --omit=psono/restapi/migrations/*,psono/middleware/*,psono/restapi/tests*"
  tags:
    - rhel


run-vulnerability-scan-python2:
  except:
    - schedules
  stage: test
  image: docker:git
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE2
    - docker run -e "LANG=C.UTF-8" $CONTAINER_TEST_IMAGE2 bash -c "pip2 install -r requirements-dev.txt && safety check"


run-vulnerability-scan-python3:
  except:
    - schedules
  stage: test
  image: docker:git
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE3
    - docker run -e "LANG=C.UTF-8" $CONTAINER_TEST_IMAGE3 bash -c "pip3 install -r requirements-dev.txt && safety check"


release-container-python2:
  except:
    - schedules
  stage: release
  image: docker:git
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE2
    - docker tag $CONTAINER_TEST_IMAGE2 $CONTAINER_RELEASE_IMAGE2
    - docker push $CONTAINER_RELEASE_IMAGE2
    - docker tag $CONTAINER_TEST_IMAGE2 $CONTAINER_LATEST_IMAGE
    - docker push $CONTAINER_LATEST_IMAGE
  only:
    - /^v[0-9]*\.[0-9]*\.[0-9]*$/

release-container-python3:
  except:
    - schedules
  stage: release
  image: docker:git
  services:
    - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE3
    - docker tag $CONTAINER_TEST_IMAGE3 $CONTAINER_RELEASE_IMAGE3
    - docker push $CONTAINER_RELEASE_IMAGE3
  only:
    - /^v[0-9]*\.[0-9]*\.[0-9]*$/


deploy:
  except:
    - schedules
  stage: deploy
  image: docker:git
  services:
    - docker:dind
  script:
    - sh ./var/deploy.sh
  environment:
    name: production
    url: https://psono.pw
  only:
    - /^v[0-9]*\.[0-9]*\.[0-9]*$/


scheduled-run-vulnerability-scan-python2:
  only:
    - schedules
  stage: test
  image: docker:git
  services:
    - docker:dind
  script:
    - docker pull psono/psono-server
    - docker run -e "LANG=C.UTF-8" psono/psono-server bash -c "pip2 install -r requirements-dev.txt && safety check"
