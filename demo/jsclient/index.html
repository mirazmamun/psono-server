<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JS Client</title>

    <!-- All of the following lines in head are kinda mandatory -->

    <!-- NaCl, SCrypt and sha512 are mandatory -->
    <script src="libs/js-nacl/lib/nacl_factory.js" type="text/javascript"></script>
    <script src="libs/scrypt/browser/scrypt.js" type="text/javascript"></script>

    <!-- Main Script -->
    <script src="client.js" type="text/javascript"></script>

    <!-- Jquery is used for all REST-API Calls -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <!-- Helper functions to call the actual functions with form parameters and display the output -->
    <script type="text/javascript">
        $(function () {
            (function () {
                "use strict";

                var client = new ClassClient();

                /*
                 *  Registraiton
                 */

                $('#generate_authkey_button_registration').click(function (event) {
                    event.preventDefault();
                    // do the magic
                    $('#authkey_registration').val(
                            client.generate_authkey($('#email_registration').val(), $('#password_registration').val())
                    );
                });

                $('#generate_secrets_registration').click(function (event) {
                    event.preventDefault();
                    var pair = client.generate_public_private_keypair();
                    $('#registration_public_key').val(pair.public_key);
                    $('#registration_private_key').val(pair.private_key);
                    $('#registration_secret_key').val(client.generate_secret_key());

                });

                $('#encrypt_secrets_registration').click(function (event) {
                    event.preventDefault();
                    var priv_key_enc = client.encrypt_secret($('#registration_private_key').val(), $('#password_registration').val());
                    var secret_key_enc = client.encrypt_secret($('#registration_secret_key').val(), $('#password_registration').val());
                    $('#registration_private_key_enc').val(priv_key_enc.ciphertext);
                    $('#registration_private_nonce_enc').val(priv_key_enc.nonce);
                    $('#registration_secret_key_enc').val(secret_key_enc.ciphertext);
                    $('#registration_secret_nonce_enc').val(secret_key_enc.nonce);
                });

                $('#registration_submitbutton').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.authentication_register(
                            $('#email_registration').val(),
                            $('#authkey_registration').val(),
                            $('#registration_public_key').val(),
                            $('#registration_private_key_enc').val(),
                            $('#registration_private_nonce_enc').val(),
                            $('#registration_secret_key_enc').val(),
                            $('#registration_secret_nonce_enc').val()
                        )
                        .done(function(value) {
                            // Registration was successful
                            jsoneditors.registration_request_feedback.set(JSON.parse(value));
                            jsoneditors.registration_request_feedback.expandAll();
                        })
                        .fail(function(value) {
                            // Registration failed
                            jsoneditors.registration_request_feedback.set(JSON.parse(value.responseText));
                            jsoneditors.registration_request_feedback.expandAll();
                        });
                });

                /*
                 *  Verify E-Mail
                 */

                $('#verify_email_button').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.authentication_verify_email($('#activation_code').val())
                        .done(function(value) {
                            // E-Mail verification was successful
                            jsoneditors.email_verification_request_feedback.set(JSON.parse(value));
                            jsoneditors.email_verification_request_feedback.expandAll();
                        })
                        .fail(function(value) {
                            // E-Mail verification failed
                            jsoneditors.email_verification_request_feedback.set(JSON.parse(value.responseText));
                            jsoneditors.email_verification_request_feedback.expandAll();
                        });
                });

                /*
                 *  Login
                 */

                $('#generate_authkey_button_login').click(function (event) {
                    event.preventDefault();
                    // do the magic
                    $('#authkey_login').val(
                            client.generate_authkey($('#email_login').val(), $('#password_login').val())
                    );
                });
                

                $('#login_submitbutton').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.authentication_login($('#email_login').val(), $('#authkey_login').val())
                        .done(function(value) {
                            // Login successful
                            jsoneditors.login_request_feedback.set(JSON.parse(value));
                            jsoneditors.login_request_feedback.expandAll();
                        })
                        .fail(function(value) {
                            // Login failed
                            jsoneditors.login_request_feedback.set(JSON.parse(value.responseText));
                            jsoneditors.login_request_feedback.expandAll();
                        });
                });

                /*
                 *  Logout
                 */

                $('#logout_submitbutton').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.authentication_logout($('#token_logout').val())
                        .done(function(value) {
                            // Logout successful
                            jsoneditors.logout_request_feedback.set(JSON.parse(value));
                            jsoneditors.logout_request_feedback.expandAll();
                        })
                        .fail(function(value) {
                            // Logout failed
                            jsoneditors.logout_request_feedback.set(JSON.parse(value.responseText));
                            jsoneditors.logout_request_feedback.expandAll();
                        });
                });

                /*
                 *  Read Datastores
                 */

                $('#read_datastore').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.read_datastore($('#token_datastore_read').val())
                        .done(function(value) {
                            // successful
                            jsoneditors.the_datastore_read.set(JSON.parse(value));
                            jsoneditors.the_datastore_read.expandAll();
                        })
                        .fail(function(value) {
                            // failed
                            jsoneditors.the_datastore_read.set(JSON.parse(value.responseText));
                            jsoneditors.the_datastore_read.expandAll();
                        });
                });

                $('#read_datastore_id').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    client.read_datastore($('#token_datastore_read_id').val(), $('#id_datastore_read_id').val())
                        .done(function(value) {
                            // successful
                            jsoneditors.the_datastore_read_id.set(JSON.parse(value));
                            jsoneditors.the_datastore_read_id.expandAll();
                        })
                        .fail(function(value) {
                            // failed
                            jsoneditors.the_datastore_read_id.set(JSON.parse(value.responseText));
                            jsoneditors.the_datastore_read_id.expandAll();
                        });
                });

                $('#decrypt_data').click(function (event) {
                    event.preventDefault();
                    // TODO do real decryption and unzipping of data
                    jsoneditors.decrypted_data.set(JSON.parse(jsoneditors.the_datastore_read_id.get().data));
                    jsoneditors.decrypted_data.expandAll();
                });

                /*
                 *  Write Datastore
                 */

                $('#write_datastore').click(function (event) {
                    event.preventDefault();
                    // do the magic, function will return a promise so handle it
                    // TODO do zipping and encryption of data
                    client.write_datastore($('#token_datastore_write').val(), $('#id_datastore_write_id').val(), jsoneditors.the_datastore_write.getText())
                        .done(function(value) {
                            // successful
                            jsoneditors.datastore_write_request_feedback.set(JSON.parse(value));
                            jsoneditors.datastore_write_request_feedback.expandAll();
                        })
                        .fail(function(value) {
                            // failed
                            jsoneditors.datastore_write_request_feedback.set(JSON.parse(value.responseText));
                            jsoneditors.datastore_write_request_feedback.expandAll();
                        });
                });

            }());
        });

    </script>

    <!-- All of the following lines in head are only for styling -->

    <!-- JQuery UI is only used for some nice styling -->
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <!-- Just some Styles, not necessary :D  -->
    <style>
        a {
            color: #1e1e1e;
        }
        .ui-widget {
            font-size: 0.9em;
        }
        section {
            margin: 20px;
        }

        section h3 {
            margin-left: -20px;
        }
    </style>

    <!-- Just some JS for JQuery UI styling, not necessary :D  -->
    <script>
        $(function () {
            $("#tabs").tabs();
        });
    </script>

    <!-- The nice json editor -->
    <link href="libs/jsoneditor/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="libs/jsoneditor/dist/jsoneditor.min.js"></script>

    <script>
        var jsoneditors = {};
        $(function() {

            var editors = [
                    'registration_request_feedback',
                    'email_verification_request_feedback',
                    'login_request_feedback',
                    'logout_request_feedback',
                    'the_datastore_read',
                    'the_datastore_read_id',
                    'datastore_write_request_feedback',
                    'the_datastore_write',
                    'decrypted_data'
                ];

            for (var i = 0; i < editors.length; i++) {
                jsoneditors[editors[i]] = new JSONEditor(document.getElementById(editors[i]), {
                    mode: 'view',
                    modes: ['code', 'form', 'text', 'tree', 'view'], // allowed modes
                    error: function (err) {
                        alert(err.toString());
                    }
                });
            }
        });
    </script>
    <style>
        .editclass {
            width: 800px;
            height: 400px;
        }
        .editclass_small {
            width: 800px;
            height: 150px;
        }
    </style>


</head>
<body>
<form>
    <h1>JS Client</h1>

    <p>This is a small demo client for the password manager in JavaScript</p>


    <div id="tabs">
        <ul>
            <li><a href="#tabs-1">Registration</a></li>
            <li><a href="#tabs-2">Verify Email</a></li>
            <li><a href="#tabs-3">Login</a></li>
            <li><a href="#tabs-4">Logout</a></li>
            <li><a href="#tabs-5">Read Datastore</a></li>
            <li><a href="#tabs-6">Write Datastore</a></li>
        </ul>
        <div id="tabs-1">
            <!-- START Registration -->
            <section>
                <h3>Step 1</h3>

                <p>Email and password are taken to generate the authkey for registration </p>
                <h4>INPUT: </h4>
                <label for="email_registration">E-Mail: </label><input size="30" type="email" name="email_registration"
                                                                       id="email_registration" value="Test@test.com">
                <label for="password_registration">Password: </label><input size="30" type="text"
                                                                            name="password_registration"
                                                                            id="password_registration"
                                                                            value="myPassword">
                <br/>
                <INPUT type="button" name="button" value="1. Generate Login Token: generate_authkey(email, password)"
                       id="generate_authkey_button_registration"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="authkey_registration">Authkey: </label>
                <br/>
                <textarea rows="3" cols="60" name="authkey_registration" id="authkey_registration" readonly></textarea>
                <br/>
                <small>It should be the following for "Test@test.com" and "myPassword":<br/>c55066421a559f76d8ed5227622e9f95a0c67df15220e40d7bc98a8a598124fa15373ac553ef3ee27c7123d6be058e6d43cc71c1b666bdecaf33b734c8583a93
                </small>
            </section>

            <hr>

            <section>
                <h3>Step 2</h3>

                <p>
                    Generate a secret key together with a public and private key pair. The private and the secret key
                    will be encrypted before being sent for storage to the server
                </p>

                <INPUT type="button" name="button"
                       value="2. Generate secrets"
                       id="generate_secrets_registration"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="registration_public_key">Public Key: </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_public_key" id="registration_public_key" readonly></textarea>
                <br/>
                <label for="registration_private_key">Private Key: </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_private_key" id="registration_private_key" readonly></textarea>
                <br/>
                <label for="registration_secret_key">Secret Key: </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_secret_key" id="registration_secret_key" readonly></textarea>
                <br/>
                <small>
                </small>

            </section>

            <hr>

            <section>
                <h3>Step 3</h3>

                <p>
                    Encrypt the private key and the secret key with the password. Public key is skipped, because as the
                    name says is the <b>public</b> key used for sharing
                </p>

                <INPUT type="button" name="button"
                       value="3. Encrypt secrets"
                       id="encrypt_secrets_registration"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="registration_private_key_enc">Private Key (encrypted): </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_private_key_enc" id="registration_private_key_enc" readonly></textarea>
                <br/>
                <label for="registration_private_nonce_enc">Private Key Nonce: </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_private_nonce_enc" id="registration_private_nonce_enc" readonly></textarea>
                <br/>
                <label for="registration_secret_key_enc">Secret Key (encrypted): </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_secret_key_enc" id="registration_secret_key_enc" readonly></textarea>
                <br/>
                <label for="registration_secret_nonce_enc">Secret Key Nonce: </label>
                <br/>
                <textarea rows="3" cols="60" name="registration_secret_nonce_enc" id="registration_secret_nonce_enc" readonly></textarea>
                <br/>
                <small>
                </small>

            </section>

            <hr>

            <section>
                <h3>Step 4</h3>

                <p>
                    Email and authkey (from step 1) are used to register with the server (Endpoint
                    <a href="/authentication/registration/">/authentication/registration/</a>)
                </p>

                <INPUT type="button" name="button"
                       value="3. Query the server for registration: register(email, authkey, public_key, private_key, private_key_nonce, secret_key, secret_key_nonce)"
                       id="registration_submitbutton"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="registration_request_feedback">Registration request feedback: </label>
                <br/>
                <div id="registration_request_feedback" class="editclass_small"></div>
                <br/>
                <small>Will return a success message or an error. An email with an email_verification_code is sent to
                    the provided email address.
                </small>

            </section>
            <!-- END Registration -->
        </div>




        <div id="tabs-2">
            <!-- START Verify E-Mail -->
            <section>
                <h3>Step 1</h3>

                <p>Takes the activation_code that has been sent to the user via E-Mail and activates the account (Endpoint
                    <a href="/authentication/login/">/authentication/verify-email/</a>)</p>
                <h4>INPUT: </h4>
                <label for="activation_code">Activation Code: </label><input size="180" type="text" name="activation_code"
                                                                id="activation_code"
                                                                value="">
                <br/>
                <INPUT type="button" name="button" value="1. Activates the email: verify_email(activation_code)"
                       id="verify_email_button"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="email_verification_request_feedback">Login Verification Feedback: </label>
                <br/>
                <div id="email_verification_request_feedback" class="editclass_small"></div>
                <br/>
                <small>Will return nothing except a success or fail message
                </small>
            </section>
            <!-- END Verify E-Mail -->
        </div>




        <div id="tabs-3">
            <!-- START Login -->
            <section>
                <h3>Step 1</h3>

                <p>Email and password are taken to generate the authkey for login (same as in registration)</p>
                <h4>INPUT: </h4>
                <label for="email_login">E-Mail: </label><input size="30" type="email" name="email_login"
                                                                id="email_login"
                                                                value="Test@test.com">
                <label for="password_login">Password: </label><input size="30" type="text" name="password_login"
                                                                     id="password_login" value="myPassword">
                <br/>
                <INPUT type="button" name="button" value="1. Generate Login Token: generate_authkey(email, password)"
                       id="generate_authkey_button_login"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="authkey_login">Authkey: </label>
                <br/>
                <textarea rows="3" cols="60" name="authkey_login" id="authkey_login" readonly></textarea>
                <br/>
                <small>It should be the following for "Test@test.com" and "myPassword":<br/>c55066421a559f76d8ed5227622e9f95a0c67df15220e40d7bc98a8a598124fa15373ac553ef3ee27c7123d6be058e6d43cc71c1b666bdecaf33b734c8583a93
                </small>
            </section>

            <hr>

            <section>
                <h3>Step 2</h3>

                <p>
                    Email and authkey (from step 1) are used to login to the server (Endpoint
                    <a href="/authentication/login/">/authentication/login/</a>) and get a token back for further
                    authentication
                </p>

                <INPUT type="button" name="button"
                       value="2. Query the server for login: login(email, authkey)"
                       id="login_submitbutton"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="login_request_feedback">Login request feedback: </label>
                <br/>
                <div id="login_request_feedback" class="editclass_small"></div>
                <br/>
                <small>Will return the token for further authentication
                </small>

            </section>
            <!-- END Login -->
        </div>




        <div id="tabs-4">
            <!-- START Logout -->
            <section>
                <h3>Step 1</h3>

                <p>Use the token from login to logout</p>
                <h4>INPUT: </h4>
                <label for="token_logout">Token: </label><input size="30" size="180" type="text" name="token_logout"
                                                                id="token_logout"
                                                                value="">
                <br/>
                <INPUT type="button" name="button" value="1. Logout: logout(token)"
                       id="logout_submitbutton"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="logout_request_feedback">Logout request feedback: </label>
                <br/>
                <div id="logout_request_feedback" class="editclass_small"></div>
                <br/>
                <small>
                </small>
            </section>
            <!-- END Logout -->
        </div>




        <div id="tabs-5">
            <!-- START Read Datastore -->
            <section>
                <h3>Step 1</h3>

                <p>Use the token from login to get a list of all datastores</p>
                <h4>INPUT: </h4>
                <label for="token_datastore_read">Token: </label><input size="30" size="180" type="text" name="token_datastore_read"
                                                                id="token_datastore_read"
                                                                value="">
                <br/>
                <INPUT type="button" name="button" value="1. Get datastore list: read_datastore(token)"
                       id="read_datastore"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="the_datastore_read">List of all datastores: </label>
                <br/>
                <div id="the_datastore_read" class="editclass"></div>
                <br/>
                <small>
                </small>
            </section>

            <hr>

            <section>
                <h3>Step 2</h3>

                <p>Use the token from login and the datastore ID to get the datastore's content</p>
                <h4>INPUT: </h4>
                <label for="token_datastore_read_id">Token: </label><input size="30" size="180" type="text" name="token_datastore_read_id"
                                                                id="token_datastore_read_id"
                                                                value="">
                <br/>
                <label for="id_datastore_read_id">Datastore ID: </label><input size="30" size="180" type="text" name="id_datastore_read_id"
                                                                id="id_datastore_read_id"
                                                                value="">
                <br/>
                <INPUT type="button" name="button" value="1. Read one datastores content: read_datastore(token, datastore_id)"
                       id="read_datastore_id"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="the_datastore_read_id">Content of one datastore: </label>
                <br/>
                <div id="the_datastore_read_id" class="editclass"></div>
                <br/>
                <small>No final decision has yet been made about the structure of the datastore, but the idea is that clients filter according to type
                </small>
            </section>

            <hr>

            <section>
                <h3>Step 3</h3>
                <p>Decrypt the content of the data attribute</p>

                <INPUT type="button" name="button" value="Decrypt Data"
                       id="decrypt_data"/>
                <br/>

                <h4>OUTPUT: </h4>
                <label for="decrypted_data">Decrypted content of the data of the fetched datastore: </label>
                <br/>
                <div id="decrypted_data" class="editclass"></div>
                <br/>
                <small>No final decision has yet been made about the structure of the datastore, but the idea is that clients filter according to type
                </small>
            </section>
            <!-- END Read Datastore -->
        </div>




        <div id="tabs-6">
            <!-- START Write Datastore -->
            <section>
                <h3>Step 1</h3>

                <p>Use the token from login to get the datastore</p>
                <h4>INPUT: </h4>
                <label for="token_datastore_write">Token: </label><input size="30" size="180" type="text" name="token_datastore_write"
                                                                id="token_datastore_write"
                                                                value="">
                <br/>
                <label for="id_datastore_write_id">Datastore ID: </label><input size="30" size="180" type="text" name="id_datastore_write_id"
                                                                id="id_datastore_write_id"
                                                                value="">
                <br/>
                <label for="the_datastore_write">Data of one datastore: </label>
                <br/>
                <div id="the_datastore_write" class="editclass"></div>
                <br/>
                <small>You can only change the data value for now.
                </small>
                <br/>
                <INPUT type="button" name="button" value="1. Write the datastore: write_datastore(token, datastore)"
                       id="write_datastore"/>
                <br/>
                <h4>OUTPUT: </h4>
                <label for="datastore_write_request_feedback">Datastore write request feedback: </label>
                <br/>
                <div id="datastore_write_request_feedback" class="editclass_small"></div>
                <small>
                </small>
            </section>
            <!-- END Write Datastore -->
        </div>

    </div>
</form>
<br>

<div style="width: 100%; text-align: center">Some unrelated links: <a href="benchmark.html">Benchmark</a> - <a href="test.html">Test</a> </div>
</body>
</html>
